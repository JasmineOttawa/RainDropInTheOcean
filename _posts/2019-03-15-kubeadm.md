---
layout: post
title: create a kubernetes cluster using kubeadm 
category: kubernetes
tags: [kubernetes]
---

task: setup kubernetes cluster using kubeadm, on centos   

step1: disable selinux
```
setenforce 0  # note this one cannot disable selinux, need following change + reboot  
sed -i 's/=enforcing/=disabled/' /etc/selinux/config  
yum upgrade -y  
reboot   
sestatus   
```

step2, disable firewall   
systemctl disable firewalld && systemctl stop firewalld  

step3, edit /etc/hosts, add all nodes in the cluster 
make sure put `hostname` in this file 

step4, add kubernetes repo   
```
cat <<EOF > /etc/yum.repos.d/kubernetes.repo  
[kubernetes]  
name=Kubernetes
baseurl=http://yum.kubernetes.io/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg
       https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF
```
got message:  'Operation too slow. Less than 1000 bytes/sec transferred the last 30 seconds') Trying other mirror.
following alternative works. 
make sure there is no blank space after EOF 
```
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=0
gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF
```

step5, install docker, kubeadm, kubectl, kubelet 
```
yum install -y docker kubelet kubeadm kubectl kubernetes-cni
systemctl enable docker && systemctl start docker
systemctl enable kubelet && systemctl start kubelet #Note that kubelet is not running at this time, it is configured by the later kubeadm init|join 
# config k8s.conf, turn off swap
sysctl -w net.bridge.bridge-nf-call-iptables=1
echo "net.bridge.bridge-nf-call-iptables=1" > /etc/sysctl.d/k8s.conf
swapoff -a &&  sed -i '/ swap / s/^/#/' /etc/fstab
```

step6, run kubeadm on master node 
```
kubeadm init   # is selinux not disabled, it throws message like : node "...." not found 
....
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 10.12.5.68:6443 --token rlpdb3.872wbnqglehpthj2 \
    --discovery-token-ca-cert-hash sha256:6e83026ef2a473941b895f6e6c88a654b3adbdf7e764107c6e36aa18179c7767
```

step7, configure environment, otherwise kubectl returns following message 
```
[root@centos-1 ~]# kubectl get nods
The connection to the server localhost:8080 was refused - did you specify the right host or port?

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
  kubectl get nods
```

step8, nodes NotReady, 
deploy network per https://kubernetes.io/docs/concepts/cluster-administration/addons/ 
```
[root@centos-1 ~]# kubectl get nodes
NAME                 STATUS     ROLES    AGE     VERSION
centos-1.novalocal   NotReady   master   5m32s   v1.14.0
centos-2.novalocal   NotReady   <none>   104s    v1.14.0
[root@centos-1 ~]# kubectl describe node centos-1.novalocal
......
KubeletNotReady  untime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized

[root@centos-1 ~]# kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"
[root@centos-1 ~]# kubectl get nodes
NAME                 STATUS   ROLES    AGE     VERSION
centos-1.novalocal   Ready    master   10m     v1.14.0
centos-2.novalocal   Ready    <none>   6m22s   v1.14.0
```



















